<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Integrated Coin Toss Game</title>
  <!-- Use ethers.js UMD build version 6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.1/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 400px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 5px 0; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Flip Flip Flipp</h2>
    <p><strong>Contract Address:</strong> 0xCA65Df209683C8b181eCFad5698f7254C6877Ce8</p>
    <p><strong>Network:</strong> Monad Testnet (Chain ID: 10143)</p>
    <p><strong>Symbol:</strong> MON</p>
    <button id="connectButton">Connect Wallet</button>
    
    <div id="walletInfo" style="display:none;">
      <p>Connected Account: <span id="accountAddress"></span></p>
      <input type="number" id="betAmount" placeholder="Enter bet amount in MON" step="0.01" min="0" />
      <div>
        <label>
          <input type="radio" name="guess" value="true" checked> Heads
        </label>
        <label>
          <input type="radio" name="guess" value="false"> Tails
        </label>
      </div>
      <button id="tossButton">Toss Coin</button>
      <pre id="result"></pre>
    </div>
  </div>

  <script>
    // Contract details
    const contractAddress = "0xCA65Df209683C8b181eCFad5698f7254C6877Ce8";
    const contractABI = [
      "function tossCoin(bool guess) public payable",
      "event CoinTossResult(address indexed player, bool guess, bool result, uint256 betAmount)"
    ];

    let provider, signer, coinTossContract;

    // Connect to MetaMask wallet using ethers v6
    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          // ethers v6: use BrowserProvider instead of Web3Provider
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          // Check network â€“ ensuring it's the Monad Testnet (Chain ID: 10143)
          const network = await provider.getNetwork();
          if (network.chainId !== 10143) {
            try {
              // Request a network switch to Monad Testnet (chainId '0x279F' in hexadecimal)
              await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x279F' }],
              });
            } catch (switchError) {
              console.error("Network switch error:", switchError);
              alert("Please switch to Monad Testnet (Chain ID: 10143) in your wallet.");
              return;
            }
          }
          
          document.getElementById("walletInfo").style.display = "block";
          const account = await signer.getAddress();
          document.getElementById("accountAddress").innerText = account;

          // Initialize the contract with the signer
          coinTossContract = new ethers.Contract(contractAddress, contractABI, signer);
          
          // Listen for CoinTossResult events to display results
          coinTossContract.on("CoinTossResult", (player, guess, result, betAmount, event) => {
            const formattedBet = ethers.formatEther(betAmount);
            const outcome = result ? "Heads" : "Tails";
            const userGuess = guess ? "Heads" : "Tails";
            document.getElementById("result").innerText =
              `Player: ${player}\nYour Guess: ${userGuess}\nResult: ${outcome}\nBet: ${formattedBet} MON`;
          });
        } catch (error) {
          console.error("Wallet connection error:", error);
          alert("Failed to connect wallet.");
        }
      } else {
        alert("MetaMask is not installed. Please install MetaMask to continue.");
      }
    }

    // Function to toss the coin with the bet and guess provided by the user
    async function tossCoin() {
      const betAmountInput = document.getElementById("betAmount").value;
      if (!betAmountInput || isNaN(betAmountInput) || Number(betAmountInput) <= 0) {
        alert("Please enter a valid bet amount in MON.");
        return;
      }
      // Convert the bet amount from MON to wei using ethers v6
      const betAmount = ethers.parseEther(betAmountInput.toString());
      
      // Get the user's guess from radio buttons (true for Heads, false for Tails)
      const guessRadios = document.getElementsByName("guess");
      let guessValue;
      for (const radio of guessRadios) {
        if (radio.checked) {
          guessValue = (radio.value === "true");
          break;
        }
      }
      
      try {
        // Call the tossCoin function of the contract with the bet value
        const tx = await coinTossContract.tossCoin(guessValue, { value: betAmount });
        document.getElementById("result").innerText = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        document.getElementById("result").innerText += "\nTransaction confirmed. Awaiting event result...";
      } catch (error) {
        console.error("Transaction error:", error);
        alert("Transaction failed: " + error.message);
      }
    }

    document.getElementById("connectButton").addEventListener("click", connectWallet);
    document.getElementById("tossButton").addEventListener("click", tossCoin);
  </script>
</body>
</html>
